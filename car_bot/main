from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes

# Buyurtmalar saqlanadi (oddiy ro'yxat, Renderda ishlaydi)
orders = []

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Assalomu alaykum! Iltimos, ismingizni kiriting:")
    return

async def name_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text

    if "first_name" not in context.user_data:
        context.user_data["first_name"] = text
        await update.message.reply_text("Familiyangizni kiriting:")
        return

    elif "last_name" not in context.user_data:
        context.user_data["last_name"] = text

        buttons = [["Spark", "Cobalt"], ["Onix", "Gentra"]]
        markup = ReplyKeyboardMarkup(buttons, one_time_keyboard=True)

        await update.message.reply_text("Modelni tanlang:", reply_markup=markup)
        return

    elif "model" not in context.user_data:
        context.user_data["model"] = text

        colors = [["Oq", "Qora"], ["Kumush", "Qizil"]]
        markup = ReplyKeyboardMarkup(colors, one_time_keyboard=True)

        await update.message.reply_text("Rangni tanlang:", reply_markup=markup)
        return

    else:
        context.user_data["color"] = text

        order = {
            "first_name": context.user_data["first_name"],
            "last_name": context.user_data["last_name"],
            "model": context.user_data["model"],
            "color": context.user_data["color"],
        }
        orders.append(order)

        await update.message.reply_text("Buyurtma qabul qilindi! Rahmat ðŸ˜Š")
        context.user_data.clear()

async def all_orders(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not orders:
        await update.message.reply_text("Hozircha buyurtmalar yoâ€˜q.")
        return
    
    msg = "ðŸ“‹ Buyurtmalar:\n\n"
    for o in orders:
        msg += f"{o['first_name']} {o['last_name']} â€” {o['model']} / {o['color']}\n"
    
    await update.message.reply_text(msg)

async def main():
    app = ApplicationBuilder().token("YOUR_BOT_TOKEN_HERE").build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("orders", all_orders))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, name_handler))

    await app.run_polling()

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
